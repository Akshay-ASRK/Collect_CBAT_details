<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBAT Report System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .logo:hover {
            color: #764ba2;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: #667eea;
        }

        .container {
            max-width: 800px;
            margin: 100px auto 50px;
            padding: 0 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            margin: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .report-table th,
        .report-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
        }

        .report-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .report-table tr:nth-child(even) {
            background-color: #f8f9ff;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            background: #eafaf1;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #27ae60;
        }

        .admin-section {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 2rem;
            border-radius: 15px;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .nav-container {
                padding: 0 1rem;
            }
            
            .container {
                padding: 0 1rem;
            }
            
            .modal-content {
                margin: 1rem;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">ðŸ“Š CBAT Score Calculator</div>
            <div class="nav-links">
                <a href="#" onclick="showHome()" target="_blank" class="btn btn-primary btn-glow me-2">
                    <i class="fas fa-home"></i> Home </a>
                <a href="#" onclick="showReports()" target="_blank" class="btn btn-success btn-glow me-2">
                    <i class="fas fa-file-alt"></i> Reports </a>
                <a href="#" onclick="openTelegramChannel()" target="_blank" class="btn btn-telegram btn-glow me-2">
                    <i class="fab fa-telegram"></i> Telegram </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Initial Modal -->
        <div id="initialModal" class="modal" style="display: flex;">
            <div class="modal-content">
                <h2>Welcome to CBAT Report System</h2>
                <p>Have you filled the form earlier?</p>
                <button class="btn" onclick="showRollNoInput()">Yes</button>
                <button class="btn btn-secondary" onclick="showForm()">No</button>
            </div>
        </div>

        <!-- Roll Number Input Modal -->
        <div id="rollNoModal" class="modal">
            <div class="modal-content">
                <h2>Enter Your Roll Number</h2>
                <div class="form-group">
                    <label for="rollNoInput">ALP 2024 CBAT Roll No (15 digits):</label>
                    <input type="text" id="rollNoInput" maxlength="15" placeholder="Enter 15-digit roll number">
                </div>
                <button class="btn" onclick="checkRollNumber()">Get Report</button>
                <button class="btn btn-secondary" onclick="showForm()">Fill New Form</button>
                <button class="btn" onclick="showInitialModal()">Back</button>
            </div>
        </div>

        <!-- Main Form -->
        <div id="mainForm" class="card hidden">
            <h2>CBAT Details Form</h2>
            <p><strong>Note:</strong> You will get CSV file on our telegram channel</p>
            
            <form id="cbatForm">
                <div class="form-group">
                    <label>1. Had you called for a re-exam of RRB ALP 2024 CBAT Exam on 31 August?</label>
                    <select id="reExam" required>
                        <option value="">Select</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>2. RRB ALP 2024 CBAT Roll Number (15 digits):</label>
                    <input type="text" id="rollNumber" required maxlength="15" pattern="[0-9]{15}" 
                           placeholder="Enter exact 15-digit roll number">
                </div>

                <div class="form-group">
                    <label>3. ALP 2024 CBT 2 Part A Marks (0-100):</label>
                    <input type="number" id="cbt2Marks" required min="0" max="100" 
                           placeholder="Enter exact marks as in score card">
                </div>

                <div class="form-group">
                    <label>4. Applied RRB Zone:</label>
                    <select id="zone" required>
                        <option value="">Select Zone</option>
                        <option value="Ahmedabad">Ahmedabad</option>
                        <option value="Ajmer">Ajmer</option>
                        <option value="Bangalore">Bangalore</option>
                        <option value="Bhopal">Bhopal</option>
                        <option value="Bhubaneswar">Bhubaneswar</option>
                        <option value="Bilaspur">Bilaspur</option>
                        <option value="Chandigarh">Chandigarh</option>
                        <option value="Chennai">Chennai</option>
                        <option value="Gorakhpur">Gorakhpur</option>
                        <option value="Guwahati">Guwahati</option>
                        <option value="Jammu and Srinagar">Jammu and Srinagar</option>
                        <option value="Kolkata">Kolkata</option>
                        <option value="Malda">Malda</option>
                        <option value="Mumbai">Mumbai</option>
                        <option value="Muzaffarpur">Muzaffarpur</option>
                        <option value="Patna">Patna</option>
                        <option value="Prayagraj">Prayagraj</option>
                        <option value="Ranchi">Ranchi</option>
                        <option value="Secunderabad">Secunderabad</option>
                        <option value="Siliguri">Siliguri</option>
                        <option value="Thiruvananthapuram">Thiruvananthapuram</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>5. RRB ALP 2024 CBAT Exam Date:</label>
                    <input type="date" id="examDate" required value="2024-07-15">
                </div>

                <div class="form-group">
                    <label>6. Shift:</label>
                    <select id="shift" required>
                        <option value="">Select Shift</option>
                        <option value="1st">1st</option>
                        <option value="2nd">2nd</option>
                        <option value="3rd">3rd</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>7. Memory (Figure-Find Memory) Battery Test 1 Attempts (0-24):</label>
                    <input type="number" id="battery1Attempts" required min="0" max="24">
                </div>

                <div class="form-group">
                    <label>8. Memory Battery Test 1 Accuracy (0-100%):</label>
                    <input type="number" id="battery1Accuracy" required min="0" max="100">
                </div>

                <div class="form-group">
                    <label>9. Directions (Watch) Battery Test 2 Attempts (0-20):</label>
                    <input type="number" id="battery2Attempts" required min="0" max="20">
                </div>

                <div class="form-group">
                    <label>10. Directions Battery Test 2 Accuracy (0-100%):</label>
                    <input type="number" id="battery2Accuracy" required min="0" max="100">
                </div>

                <div class="form-group">
                    <label>11. Depth Perception (Hidden Cube) Battery Test 3 Attempts (0-50):</label>
                    <input type="number" id="battery3Attempts" required min="0" max="50">
                </div>

                <div class="form-group">
                    <label>12. Depth Perception Battery Test 3 Accuracy (0-100%):</label>
                    <input type="number" id="battery3Accuracy" required min="0" max="100">
                </div>

                <div class="form-group">
                    <label>13. Concentration (Figure Placement) Battery Test 4 Attempts (0-60):</label>
                    <input type="number" id="battery4Attempts" required min="0" max="60">
                </div>

                <div class="form-group">
                    <label>14. Concentration Battery Test 4 Accuracy (0-100%):</label>
                    <input type="number" id="battery4Accuracy" required min="0" max="100">
                </div>

                <div class="form-group">
                    <label>15. Perceptual Speed (Same Figure Matching) Battery Test 5 Attempts (0-72):</label>
                    <input type="number" id="battery5Attempts" required min="0" max="72">
                </div>

                <div class="form-group">
                    <label>16. Perceptual Speed Battery Test 5 Accuracy (0-100%):</label>
                    <input type="number" id="battery5Accuracy" required min="0" max="100">
                </div>

                <button type="submit" class="btn">Submit Form</button>
                <button type="button" class="btn btn-secondary" onclick="showInitialModal()">Back</button>
            </form>
        </div>

        <!-- Report Display -->
        <div id="reportSection" class="card hidden">
            <div id="reportContent"></div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Processing your request...</p>
        </div>

        <!-- Admin Section (hidden by default) -->
        <div id="adminSection" class="admin-section hidden">
            <h2>Admin Panel</h2>
            <div class="form-group">
                <label for="adminPassword">Enter Admin Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter password">
            </div>
            <button class="btn" onclick="verifyAdmin()">Login</button>
            
            <div id="adminControls" class="hidden">
                <h3>Admin Controls</h3>
                <button class="btn" onclick="generateCSV()">Generate CSV Report</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Data Already Exists</h2>
            <p>Are you sure you want to change the data that was filled earlier?</p>
            <button class="btn" onclick="confirmUpdate(true)">Yes, Update</button>
            <button class="btn btn-secondary" onclick="confirmUpdate(false)">No, Show Existing Report</button>
        </div>
    </div>

    <script>
        // Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbworRhBQkGxA5aDvVszUwdt2PZcLvzoZCmzg2TST1ZcsW4dZfWtOLcbqVQN-ZMw5ol5/exec'; // Replace with your deployed Google Apps Script URL
        const TELEGRAM_CHANNEL = 'https://t.me/Akki_Inspire'; // Replace with your telegram channel
        const ADMIN_PASSWORD = 'mjhgjfgdxtfcghjk.jnb$@#%^*((*&^%%#$%(^)))BHGBdtrhvbyuftyu$%%&^R6vhnvhjgb'; // Replace with your admin password

        // Global variables
        let currentFormData = {};
        let pendingUpdate = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're on admin route
            if (window.location.pathname.includes('/admin') || window.location.hash === '#admin') {
                showAdmin();
            }
            
            // Form submission
            document.getElementById('cbatForm').addEventListener('submit', handleFormSubmit);
        });

        // Navigation functions
        function showHome() {
            hideAllSections();
            document.getElementById('initialModal').style.display = 'flex';
        }

        function showReports() {
            showRollNoInput();
        }

        function showInitialModal() {
            hideAllSections();
            document.getElementById('initialModal').style.display = 'flex';
        }

        function showRollNoInput() {
            hideAllSections();
            document.getElementById('rollNoModal').style.display = 'flex';
            document.getElementById('rollNoInput').focus();
        }

        function showForm() {
            hideAllSections();
            document.getElementById('mainForm').classList.remove('hidden');
        }

        function showAdmin() {
            hideAllSections();
            document.getElementById('adminSection').classList.remove('hidden');
        }

        function hideAllSections() {
            document.getElementById('initialModal').style.display = 'none';
            document.getElementById('rollNoModal').style.display = 'none';
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('mainForm').classList.add('hidden');
            document.getElementById('reportSection').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
        }

        function openTelegramChannel() {
            window.open(TELEGRAM_CHANNEL, '_blank');
        }

        // Form handling
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = collectFormData();
            if (!validateFormData(formData)) {
                return;
            }

            currentFormData = formData;
            showLoading();
            
            // Check if roll number already exists
            checkRollNumberExists(formData.rollNumber)
                .then(exists => {
                    hideLoading();
                    if (exists) {
                        showConfirmModal();
                    } else {
                        submitFormData(formData);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showError('Error checking roll number: ' + error.message);
                });
        }

        function collectFormData() {
            return {
                reExam: document.getElementById('reExam').value,
                rollNumber: document.getElementById('rollNumber').value,
                cbt2Marks: parseInt(document.getElementById('cbt2Marks').value),
                zone: document.getElementById('zone').value,
                examDate: document.getElementById('examDate').value,
                shift: document.getElementById('shift').value,
                battery1Attempts: parseInt(document.getElementById('battery1Attempts').value),
                battery1Accuracy: parseInt(document.getElementById('battery1Accuracy').value),
                battery2Attempts: parseInt(document.getElementById('battery2Attempts').value),
                battery2Accuracy: parseInt(document.getElementById('battery2Accuracy').value),
                battery3Attempts: parseInt(document.getElementById('battery3Attempts').value),
                battery3Accuracy: parseInt(document.getElementById('battery3Accuracy').value),
                battery4Attempts: parseInt(document.getElementById('battery4Attempts').value),
                battery4Accuracy: parseInt(document.getElementById('battery4Accuracy').value),
                battery5Attempts: parseInt(document.getElementById('battery5Attempts').value),
                battery5Accuracy: parseInt(document.getElementById('battery5Accuracy').value)
            };
        }

        function validateFormData(data) {
            if (data.rollNumber.length !== 15 || !/^\d{15}$/.test(data.rollNumber)) {
                showError('Roll number must be exactly 15 digits');
                return false;
            }
            return true;
        }

        function checkRollNumber() {
            const rollNo = document.getElementById('rollNoInput').value.trim();
            if (!rollNo || rollNo.length !== 15 || !/^\d{15}$/.test(rollNo)) {
                showError('Please enter a valid 15-digit roll number');
                return;
            }

            showLoading();
            fetchStudentData(rollNo)
                .then(data => {
                    hideLoading();
                    if (data) {
                        generateAndShowReport(data);
                    } else {
                        showError('Roll number not found. Please try again or fill the form.');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showError('Error fetching data: ' + error.message);
                });
        }

        // API functions
        async function checkRollNumberExists(rollNumber) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'checkRollNumber', rollNumber })
                });
                const result = await response.json();
                return result.exists;
            } catch (error) {
                throw new Error('Failed to check roll number');
            }
        }

        async function fetchStudentData(rollNumber) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getStudentData', rollNumber })
                });
                const result = await response.json();
                return result.data;
            } catch (error) {
                throw new Error('Failed to fetch student data');
            }
        }

        async function submitFormData(formData, update = false) {
            try {
                showLoading();
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: update ? 'updateStudent' : 'addStudent', 
                        data: formData 
                    })
                });
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    generateAndShowReport(result.studentData);
                } else {
                    showError('Error submitting form: ' + result.error);
                }
            } catch (error) {
                hideLoading();
                showError('Error submitting form: ' + error.message);
            }
        }

        // Report generation
        function generateAndShowReport(studentData) {
            showLoading();
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'generateReport', 
                    studentData: studentData 
                })
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();
                if (result.success) {
                    displayReport(result.report, studentData);
                } else {
                    showError('Error generating report: ' + result.error);
                }
            })
            .catch(error => {
                hideLoading();
                showError('Error generating report: ' + error.message);
            });
        }

        function displayReport(reportData, studentData) {
            hideAllSections();
            
            const reportContent = document.getElementById('reportContent');
            const isReExam = studentData.reExam === 'Yes';
            
            reportContent.innerHTML = `
                <h2>CBAT Performance Report</h2>
                <div class="success">
                    <strong>Student Details:</strong><br>
                    Roll Number: ${studentData.rollNumber}<br>
                    Zone: ${studentData.zone}<br>
                    Exam Date: ${studentData.examDate}<br>
                    Shift: ${studentData.shift}<br>
                    Re-exam Status: ${studentData.reExam}<br>
                    CBT2 Part A Marks: ${studentData.cbt2Marks}
                </div>
                
                <h3>Battery Test Results</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Battery Test</th>
                            <th>Your Raw Score</th>
                            <th>Group Average</th>
                            <th>Standard Deviation</th>
                            <th>T-Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Memory (Figure-Find)</td>
                            <td>${reportData.battery1.rawScore}</td>
                            <td>${reportData.battery1.average.toFixed(2)}</td>
                            <td>${reportData.battery1.stdDev.toFixed(2)}</td>
                            <td>${reportData.battery1.tScore.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Directions (Watch)</td>
                            <td>${reportData.battery2.rawScore}</td>
                            <td>${reportData.battery2.average.toFixed(2)}</td>
                            <td>${reportData.battery2.stdDev.toFixed(2)}</td>
                            <td>${reportData.battery2.tScore.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Depth Perception (Hidden Cube)</td>
                            <td>${reportData.battery3.rawScore}</td>
                            <td>${reportData.battery3.average.toFixed(2)}</td>
                            <td>${reportData.battery3.stdDev.toFixed(2)}</td>
                            <td>${reportData.battery3.tScore.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Concentration (Figure Placement)</td>
                            <td>${reportData.battery4.rawScore}</td>
                            <td>${reportData.battery4.average.toFixed(2)}</td>
                            <td>${reportData.battery4.stdDev.toFixed(2)}</td>
                            <td>${reportData.battery4.tScore.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Perceptual Speed (Same Figure Matching)</td>
                            <td>${reportData.battery5.rawScore}</td>
                            <td>${reportData.battery5.average.toFixed(2)}</td>
                            <td>${reportData.battery5.stdDev.toFixed(2)}</td>
                            <td>${reportData.battery5.tScore.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="success" style="margin-top: 2rem;">
                    <h3>Overall Score: ${reportData.overallScore.toFixed(2)}/30</h3>
                    <p><strong>Group:</strong> ${isReExam ? 'Re-exam Candidates' : 'Regular Candidates'}</p>
                    <p><strong>Comparison Group:</strong> ${studentData.zone} - ${studentData.examDate} - ${studentData.shift}</p>
                </div>
                
                <button class="btn" onclick="showInitialModal()">Generate Another Report</button>
                <button class="btn btn-secondary" onclick="window.print()">Print Report</button>
            `;
            
            document.getElementById('reportSection').classList.remove('hidden');
        }

        // Modal functions
        function showConfirmModal() {
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function confirmUpdate(shouldUpdate) {
            document.getElementById('confirmModal').style.display = 'none';
            
            if (shouldUpdate) {
                submitFormData(currentFormData, true);
            } else {
                // Show existing report
                fetchStudentData(currentFormData.rollNumber)
                    .then(data => {
                        if (data) {
                            generateAndShowReport(data);
                        }
                    });
            }
        }

        // Admin functions
        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('adminControls').classList.remove('hidden');
                showSuccess('Admin access granted');
            } else {
                showError('Invalid admin password');
            }
        }

        function generateCSV() {
            showLoading();
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'generateCSV' })
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();
                if (result.success) {
                    downloadCSV(result.csvData, 'cbat_report.csv');
                    showSuccess('CSV report generated successfully');
                } else {
                    showError('Error generating CSV: ' + result.error);
                }
            })
            .catch(error => {
                hideLoading();
                showError('Error generating CSV: ' + error.message);
            });
        }

        function downloadCSV(csvData, filename) {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Utility functions
        function showLoading() {
            hideAllSections();
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '100px';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translateX(-50%)';
            errorDiv.style.zIndex = '3000';
            errorDiv.style.maxWidth = '80%';
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '100px';
            successDiv.style.left = '50%';
            successDiv.style.transform = 'translateX(-50%)';
            successDiv.style.zIndex = '3000';
            successDiv.style.maxWidth = '80%';
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // Handle browser routing for admin
        window.addEventListener('hashchange', function() {
            if (window.location.hash === '#admin') {
                showAdmin();
            }
        });

        // Handle direct admin URL access
        if (window.location.pathname.includes('admin') || window.location.hash === '#admin') {
            document.addEventListener('DOMContentLoaded', function() {
                showAdmin();
            });
        }
    </script>
</body>
</html> '
