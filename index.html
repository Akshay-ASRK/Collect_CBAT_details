<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RRB ALP 2024 CBAT Data Collector</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    .field { margin-bottom:12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .pill { background:#eee; padding:4px 8px; border-radius:4px; margin:2px; }
    #firstPopup { position:fixed; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); }
    #firstPopup .box { background:white; padding:20px; border-radius:6px; max-width:400px; text-align:center; }
    #formWrap, #reportWrap, #adminWrap { display:none; margin-top:20px; }
    table { border-collapse:collapse; width:100%; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
  </style>
</head>
<body>
  <h1>RRB ALP 2024 CBAT</h1>

  <!-- Popup -->
  <div id="firstPopup" style="display:none">
    <div class="box">
      <p>Do you already know your Roll No?</p>
      <button onclick="onPopupAnswer(true)">Yes</button>
      <button onclick="onPopupAnswer(false)">No</button>
    </div>
  </div>

  <!-- Form -->
  <div id="formWrap">
    <h2>Enter Your Details</h2>
    <form id="cbatForm" class="row"></form>
    <button id="submitBtn" type="button">Submit</button>
    <button type="button" onclick="resetForm()">Reset</button>
  </div>

  <!-- Report -->
  <div id="reportWrap">
    <h2>Your Report</h2>
    <div id="reportMeta"></div>
    <table id="reportTable"></table>
    <button onclick="scrollToTop()">Back to Top</button>
  </div>

  <!-- Admin -->
  <div id="adminWrap">
    <h2>Admin Panel</h2>
    <input type="password" id="adminPass" placeholder="Enter admin password">
    <button onclick="downloadCSV()">Download CSV</button>
    <div id="adminHint" style="display:none">Downloadingâ€¦</div>
  </div>

  <!-- Script -->
  <script>
  /* ===== CONFIG ===== */
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxg1sD163E6pBlZshzQ1vp3xLEvW2jc1vdD7ccbiZm9WLjlCRkR-Si1pK37wnSA2zdO3g/exec";

  /* ===== UTIL ===== */
  const qs = sel => document.querySelector(sel);
  const qsa = sel => [...document.querySelectorAll(sel)];
  function toast(msg, type='info'){ alert(msg); }
  function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}); }

  /* ===== INIT ===== */
  const pathIsAdmin = location.pathname.endsWith('/admin') || location.hash==='#admin';
  document.addEventListener('DOMContentLoaded', () => {
    if (pathIsAdmin) {
      qs('#adminWrap').style.display = 'block';
    } else {
      qs('#firstPopup').style.display = 'flex';
      buildForm();
    }
  });

  /* ===== POPUP FLOW ===== */
  function onPopupAnswer(yes){
    qs('#firstPopup').style.display = 'none';
    if (yes){
      const roll = prompt('Enter your 15 digit ALP 2024 CBAT Roll No:');
      if (!roll) { qs('#formWrap').style.display = 'block'; return; }
      if (!/^\d{15}$/.test(roll)){ toast('Roll No must be exactly 15 digits.'); qs('#formWrap').style.display='block'; return; }
      fetchReport(roll).then(r=>{
        if (r.status==='ok'){
          renderReport(r);
        } else if (r.status==='not_found'){
          if (confirm('Roll not found. Try again? Click "Cancel" to fill the form.')) {
            onPopupAnswer(true);
          } else {
            qs('#formWrap').style.display = 'block';
          }
        } else {
          toast('Error fetching report. Please fill the form.');
          qs('#formWrap').style.display = 'block';
        }
      }).catch(()=>{ toast('Network error. Please fill the form.'); qs('#formWrap').style.display='block'; });
    } else {
      qs('#formWrap').style.display = 'block';
    }
  }

  /* ===== API CALLS ===== */
  async function apiGet(params){
    const url = SCRIPT_URL + '?' + new URLSearchParams(params).toString();
    const res = await fetch(url, { method:'GET', mode:'cors' });
    const ct = res.headers.get('content-type')||'';
    if (ct.includes('application/json')) return res.json();
    return res.text();
  }
  async function apiPostJson(obj){
    const res = await fetch(SCRIPT_URL, {
      method:'POST', mode:'cors',
      headers:{ 'Content-Type':'text/plain' },
      body: JSON.stringify(obj)
    });
    const ct = res.headers.get('content-type')||'';
    if (ct.includes('application/json')) return res.json();
    return res.text();
  }
  async function fetchReport(roll){ return apiGet({ action:'getReport', roll }); }
  async function checkRollExists(roll){ const r = await apiPostJson({ type:'checkRoll', roll }); return !!(r && r.exists); }
  async function saveOrUpdate(payload, forceUpdate=false){ return apiPostJson({ type:'saveOrUpdate', payload, forceUpdate }); }

  /* ===== FORM ===== */
  function buildForm(){
    const f = qs('#cbatForm'); f.innerHTML = '';
    const addField=(l,id,t='text',a={})=>{const w=document.createElement('div');w.className='field col-6';w.innerHTML=`<label>${l}</label>`;const i=document.createElement('input');i.id=id;i.type=t;Object.entries(a).forEach(([k,v])=>i.setAttribute(k,v));w.appendChild(i);f.appendChild(w);};
    const addSelect=(l,id,opt,a={})=>{const w=document.createElement('div');w.className='field col-6';w.innerHTML=`<label>${l}</label>`;const s=document.createElement('select');s.id=id;Object.entries(a).forEach(([k,v])=>s.setAttribute(k,v));s.innerHTML='<option value="">-- Select --</option>';opt.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;s.appendChild(o);});w.appendChild(s);f.appendChild(w);};
    const addNumber=(l,id,min,max,step=1)=>addField(l,id,'number',{min,max,step,required:'required'});
    addSelect('Re-Exam 31 Aug?','ReExam',['Yes','No'],{required:'required'});
    addField('15-digit Roll No','RollNo','text',{required:'required',pattern:'\\d{15}',maxlength:'15'});
    addNumber('CBT-2 Part A Marks','PartAMarks',0,100);
    addSelect('Zone','Zone',['Ahmedabad','Ajmer','Bangalore','Bhopal','Bhubaneswar','Bilaspur','Chandigarh','Chennai','Gorakhpur','Guwahati','Jammu and Srinagar','Kolkata','Malda','Mumbai','Muzaffarpur','Patna','Prayagraj','Ranchi','Secunderabad','Siliguri','Thiruvananthapuram'],{required:'required'});
    addField('Exam Date','ExamDate','text',{required:'required',value:'15-July-2024'});
    addSelect('Shift','Shift',['1st','2nd','3rd'],{required:'required'});
    addNumber('Battery1 Attempts','Mem_Attempts',0,24); addNumber('Battery1 Accuracy','Mem_Accuracy',0,100);
    addNumber('Battery2 Attempts','Dir_Attempts',0,20); addNumber('Battery2 Accuracy','Dir_Accuracy',0,100);
    addNumber('Battery3 Attempts','Depth_Attempts',0,50); addNumber('Battery3 Accuracy','Depth_Accuracy',0,100);
    addNumber('Battery4 Attempts','Conc_Attempts',0,60); addNumber('Battery4 Accuracy','Conc_Accuracy',0,100);
    addNumber('Battery5 Attempts','Perc_Attempts',0,72); addNumber('Battery5 Accuracy','Perc_Accuracy',0,100);
    qs('#submitBtn').onclick = onSubmitForm;
  }
  function getFormData(){ const v=id=>(qs('#'+id).value||'').trim(); const n=id=>Number(v(id)); return {ReExam:v('ReExam'),RollNo:v('RollNo'),PartAMarks:n('PartAMarks'),Zone:v('Zone'),ExamDate:v('ExamDate'),Shift:v('Shift'),Mem_Attempts:n('Mem_Attempts'),Mem_Accuracy:n('Mem_Accuracy'),Dir_Attempts:n('Dir_Attempts'),Dir_Accuracy:n('Dir_Accuracy'),Depth_Attempts:n('Depth_Attempts'),Depth_Accuracy:n('Depth_Accuracy'),Conc_Attempts:n('Conc_Attempts'),Conc_Accuracy:n('Conc_Accuracy'),Perc_Attempts:n('Perc_Attempts'),Perc_Accuracy:n('Perc_Accuracy')}; }
  function validatePayload(p){ if(!['Yes','No'].includes(p.ReExam)) return 'Select ReExam'; if(!/^\d{15}$/.test(p.RollNo)) return 'Roll 15 digits'; return null; }
  async function onSubmitForm(){ const p=getFormData(),err=validatePayload(p); if(err){toast(err);return;} try{const ex=await checkRollExists(p.RollNo); if(ex){if(confirm('Roll exists. Overwrite?')){const r=await saveOrUpdate(p,true);if(r&&r.status==='ok'&&r.report)renderReport(r.report);}else{const r=await fetchReport(p.RollNo);if(r&&r.status==='ok')renderReport(r);}}else{const r=await saveOrUpdate(p,false);if(r&&r.status==='ok'&&r.report)renderReport(r.report);} }catch(e){toast('Network error.');}}
  function resetForm(){ qsa('#cbatForm input,#cbatForm select').forEach(el=>{if(el.id==='ExamDate')el.value='15-July-2024';else if(el.tagName==='SELECT')el.selectedIndex=0;else el.value='';}); }

  /* ===== REPORT ===== */
  function renderReport(d){ qs('#reportWrap').style.display='block'; qs('#formWrap').style.display='none'; const m=d.meta; qs('#reportMeta').innerHTML=`<h2>Report for Roll: ${m.roll}</h2><div class="row"><span class="pill">Zone: <b>${m.zone}</b></span><span class="pill">Date: <b>${m.examDate}</b></span><span class="pill">Shift: <b>${m.shift}</b></span><span class="pill">Group: <b>${m.reportType}</b></span><span class="pill">Group Size: <b>${m.groupSize}</b></span></div>`; const rows=[['Battery','Mean','SD','Raw','T'],[d.batteries.B1.name,d.batteries.B1.mean,d.batteries.B1.sd,d.batteries.B1.raw,d.batteries.B1.t],[d.batteries.B2.name,d.batteries.B2.mean,d.batteries.B2.sd,d.batteries.B2.raw,d.batteries.B2.t],[d.batteries.B3.name,d.batteries.B3.mean,d.batteries.B3.sd,d.batteries.B3.raw,d.batteries.B3.t],[d.batteries.B4.name,d.batteries.B4.mean,d.batteries.B4.sd,d.batteries.B4.raw,d.batteries.B4.t],[d.batteries.B5.name,d.batteries.B5.mean,d.batteries.B5.sd,d.batteries.B5.raw,d.batteries.B5.t]]; let html='<thead><tr>'+rows[0].map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>'; for(let i=1;i<rows.length;i++){html+='<tr>'+rows[i].map((c,j)=>`<td>${j===0?'<b>'+c+'</b>':c}</td>`).join('')+'</tr>';} html+='</tbody><tfoot><tr><th colspan="4">Overall Score</th><th>'+d.overall+'</th></tr></tfoot>'; qs('#reportTable').innerHTML=html; }

  /* ===== ADMIN ===== */
  async function downloadCSV(){ const pass=qs('#adminPass').value||''; if(!pass){toast('Enter password');return;} qs('#adminHint').style.display='block'; try{const url=SCRIPT_URL+'?'+new URLSearchParams({action:'adminExport',password:pass}); const res=await fetch(url); if(!res.ok){toast('Error or unauthorized');qs('#adminHint').style.display='none';return;} const blob=await res.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='CBAT_Export.csv'; a.click(); qs('#adminHint').style.display='none'; }catch(e){toast('Network error');qs('#adminHint').style.display='none';}}
  </script>
</body>
</html>
