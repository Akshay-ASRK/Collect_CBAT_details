<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ALP 2024 CBAT Reports</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  /* ---- Basic, attractive styling ---- */
  :root{--accent:#0b63d6;--muted:#666;--bg:#f6f9ff}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:#222}
  .nav{display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:#fff;box-shadow:0 2px 6px rgba(20,40,80,0.06)}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{font-size:18px;margin:0;color:var(--accent)}
  .nav a{color:var(--muted);text-decoration:none;margin-left:12px}
  .container{max-width:980px;margin:28px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 8px 30px rgba(20,40,80,0.05)}
  .hero{display:flex;align-items:center;gap:18px}
  .hero h2{margin:0}
  .btn{background:var(--accent);color:#fff;padding:8px 14px;border-radius:8px;border:0;cursor:pointer}
  .muted{color:var(--muted)}
  .card{padding:14px;background:#f8fbff;border-radius:8px;margin-top:12px}
  input,select{padding:8px;border-radius:6px;border:1px solid #e0e6f0;width:100%}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .full{grid-column:1/-1}
  label{font-size:13px;color:#333}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eef3ff;text-align:left}
  .tg{background:linear-gradient(90deg,#f7fbff,#fff)}
  .center{text-align:center}
  .link-telegram{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #e6f0ff;padding:8px 10px;border-radius:8px}
  /* popup modal */
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal .inner{background:#fff;padding:18px;border-radius:10px;max-width:520px;width:92%}
  .warn{background:#fff7f6;border-left:4px solid #ff6b6b;padding:10px;border-radius:6px}
  .ok{background:#f6fffb;border-left:4px solid #24b47e;padding:10px;border-radius:6px}
  .flex{display:flex;gap:10px;align-items:center}
  .tiny{font-size:12px;color:var(--muted)}
  footer{padding:18px;text-align:center;color:var(--muted);font-size:13px}
  @media (max-width:740px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <nav class="nav">
    <div class="brand">
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden><rect rx="6" width="24" height="24" fill="#0b63d6"></rect></svg>
      <div>
        <h1>ALP 2024 CBAT Reports</h1>
        <div class="tiny">Instant T-score & overall reports</div>
      </div>
    </div>
    <div>
      <a href="#" id="homeBtn">Home</a>
      <a href="/admin" id="adminLink">/admin</a>
      <a class="link-telegram" id="tgLink" target="_blank" rel="noopener">
        <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="tg" width="18" style="filter:grayscale(100%);opacity:.9">
        Click here
      </a>
    </div>
  </nav>

  <main class="container" id="app">
    <section class="hero">
      <div style="flex:1">
        <h2>Reports — ALP 2024 CBAT</h2>
        <div class="small">Load the page and follow the prompts. You can check by Roll No or submit the CBAT form.</div>
      </div>
      <div>
        <button class="btn" id="fillNowBtn">Fill Form</button>
      </div>
    </section>

    <div id="mainContent" style="margin-top:16px"></div>
  </main>

  <footer>Built for ALP 2024 CBAT — Data is stored in Google Sheets. Admin can download full CSV at /admin</footer>

  <!-- Modal container -->
  <div id="modalRoot"></div>

<script>
/*
  index.html front-end JS
  Replace GAS_WEBAPP_URL with your deployed Apps Script Web App URL
*/
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyv76dDZ4_gFJmSUWFtAv1BIONP2C9TqJfCqngRA_nYd3aW957_JJRIToGHg8Sw0N59/exec";
const TELEGRAM_LINK = "https://t.me/Akki_Inspire"; // same as in Apps Script

// wire telegram link
document.getElementById('tgLink').href = TELEGRAM_LINK;
document.getElementById('homeBtn').addEventListener('click', (e) => { e.preventDefault(); navigateHome(); });

// basic routing for /admin
(function initRouting(){
  const path = location.pathname || "/";
  if (path.endsWith("/admin") || path.includes("#/admin") || path.endsWith("/admin/")) {
    showAdminPrompt();
    return;
  }
  showStartupModal();
})();

document.getElementById('fillNowBtn').addEventListener('click', (e) => {
  e.preventDefault();
  showForm();
});

/* ---------- UI helpers ---------- */

function el(tag, props = {}, children = []) {
  const node = document.createElement(tag);
  for (const k in props) {
    if (k === "class") node.className = props[k];
    else if (k === "html") node.innerHTML = props[k];
    else node.setAttribute(k, props[k]);
  }
  (Array.isArray(children) ? children : [children]).forEach(c => {
    if (!c) return;
    if (typeof c === "string") node.appendChild(document.createTextNode(c));
    else node.appendChild(c);
  });
  return node;
}

function showModal(contentNode) {
  const root = document.getElementById('modalRoot');
  root.innerHTML = '';
  const m = el('div',{class:'modal'});
  const inner = el('div',{class:'inner'});
  inner.appendChild(contentNode);
  m.appendChild(inner);
  root.appendChild(m);
}

function closeModal() {
  const root = document.getElementById('modalRoot');
  root.innerHTML = '';
}

/* ---------- Startup popup ---------- */
function showStartupModal() {
  const node = el('div',{},[
    el('h3',{},['Have you already filled the form earlier?']),
    el('div',{class:'tiny'},['Choose Yes if you filled before (then you can enter Roll No to see report). Choose No to fill the form now.']),
    el('div',{style:'margin-top:12px;display:flex;gap:8px'},[
      el('button',{class:'btn', id:'mYes'},['Yes']),
      el('button',{class:'btn', id:'mNo'},['No'])
    ])
  ]);
  showModal(node);
  document.getElementById('mYes').addEventListener('click', () => {
    closeModal();
    askRollForReport();
  });
  document.getElementById('mNo').addEventListener('click', () => {
    closeModal();
    showForm();
  });
}

/* ---------- Ask Roll ---------- */
function askRollForReport() {
  const node = el('div',{},[
    el('h3',{},['Enter your ALP 15-digit Roll No']),
    el('input',{id:'inpRoll', placeholder:'Exact 15-digit roll', style:'width:100%;margin-top:8px'}),
    el('div',{style:'margin-top:12px;display:flex;gap:12px'},[
      el('button',{class:'btn', id:'lookupBtn'},['Lookup']),
      el('button',{class:'btn', id:'openFormBtn'},['Open Form'])
    ])
  ]);
  showModal(node);
  document.getElementById('lookupBtn').addEventListener('click', async ()=>{
    const roll = document.getElementById('inpRoll').value.trim();
    if (!/^\d{15}$/.test(roll)) { alert('Enter exact 15 digits'); return; }
    closeModal();
    await lookupRollAndShow(roll);
  });
  document.getElementById('openFormBtn').addEventListener('click', ()=>{
    closeModal();
    showForm();
  });
}

/* ---------- Lookup roll & show report ---------- */
async function lookupRollAndShow(roll) {
  showSpinner('Looking up roll...');
  try {
    const res = await fetch(GAS_WEBAPP_URL + '?action=getreport&roll=' + encodeURIComponent(roll));
    const json = await res.json();
    hideSpinner();
    if (!json.ok) {
      // not found -> ask to fill form
      alert('Roll not found. Please fill the form.');
      showForm();
      return;
    }
    renderReport(json.report);
  } catch (err) {
    hideSpinner();
    alert('Error contacting server. Check GAS_WEBAPP_URL and deploy settings.');
    console.error(err);
  }
}

function renderReport(report) {
  const c = report.candidate;
  const batteryHeaders = ['Memory','Directions','Depth Perception','Concentration','Perceptual Speed'];
  const container = document.getElementById('mainContent');
  container.innerHTML = '';
  const heading = el('div',{},[
    el('h3',{},[`Report for Roll ${c.roll}`]),
    el('div',{class:'tiny'},[`Exam Date: ${c.examDate} • Shift: ${c.shift} • Re-Exam: ${report.candidate.reexam}`]),
    el('div',{class:'card'},[
      el('strong',{},['Overall Out of 30: '] ), el('span',{},[' ' + c.overallOutOf30])
    ])
  ]);
  container.appendChild(heading);

  // Battery table with raw, mean, sd, T
  const table = el('table');
  const thead = el('thead');
  thead.innerHTML = '<tr><th>Battery</th><th>Raw</th><th>Mean</th><th>SD</th><th>T-Score</th></tr>';
  table.appendChild(thead);
  const tbody = el('tbody');
  for (let i=0;i<5;i++){
    const tr = el('tr');
    tr.innerHTML = `<td>${batteryHeaders[i]}</td>
      <td>${c.raw[i]}</td>
      <td>${round(report.batteryStats[i].mean,3)}</td>
      <td>${round(report.batteryStats[i].sd,3)}</td>
      <td>${c.tScores[i]}</td>`;
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  container.appendChild(table);

  // Two sets (Set A & B) as per spec
  container.appendChild(el('h4',{},[`Report Set A`]));
  container.appendChild(renderReportSet(report.setA));
  container.appendChild(el('h4',{},[`Report Set B`]));
  container.appendChild(renderReportSet(report.setB));
  window.scrollTo({top:0,behavior:'smooth'});
}

function renderReportSet(arr) {
  const wrap = el('div', {class:'card'});
  if (!arr || arr.length === 0) {
    wrap.appendChild(el('div',{},['No candidates in this set.']));
    return wrap;
  }
  const tbl = el('table');
  const th = el('thead'); th.innerHTML = '<tr><th>Roll</th><th>Re-Exam</th><th>Raw (5)</th><th>T (5)</th><th>T Sum</th><th>Overall/30</th></tr>';
  tbl.appendChild(th);
  const tb = el('tbody');
  arr.forEach(r=>{
    const tr = el('tr');
    tr.innerHTML = `<td>${r.roll}</td><td>${r.reexam}</td><td>${r.raw.join(', ')}</td><td>${r.tScores.join(', ')}</td><td>${r.tSum}</td><td>${r.overall}</td>`;
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
  wrap.appendChild(tbl);
  return wrap;
}

/* ---------- Form UI ---------- */
function showForm(prefill = {}) {
  const container = document.getElementById('mainContent');
  container.innerHTML = '';

  const form = el('form', {id:'cform'});
  const grid = el('div',{class:'grid'});
  // 1. Re-exam Yes/No
  grid.appendChild(el('div',{},[
    el('label',{},['Had you called for a re-exam on 31 August?']),
    selectYesNo('reexam', prefill.reexam)
  ]));
  // 2. roll
  grid.appendChild(el('div',{},[
    el('label',{},['15-digit Roll No (exact)']),
    el('input',{id:'roll',name:'roll',placeholder:'123456789012345', required:true, value: prefill.roll || ''})
  ]));
  // 3. CBT2 part A marks 0-100
  grid.appendChild(el('div',{},[
    el('label',{},['ALP 2024 CBT2 Part A Marks (0-100)']),
    el('input',{id:'cbt2',name:'cbt2',type:'number',min:0,max:100,required:true,value:prefill.cbt2||''})
  ]));
  // 4. Zone select
  grid.appendChild(el('div',{},[
    el('label',{},['Applied RRB Zone']),
    zoneSelect('zone', prefill.zone || '')
  ]));

  // 5. exam date
  grid.appendChild(el('div',{},[
    el('label',{},['RRB ALP 2024 CBAT Exam date']),
    el('input',{id:'examDate',name:'examDate',type:'text',placeholder:'15-July-2024', required:true, value: prefill.examDate || '15-July-2024'})
  ]));

  // 6. shift
  grid.appendChild(el('div',{},[
    el('label',{},['Shift']),
    el('select',{id:'shift',name:'shift', required:true, html:`<option value="1st">1st</option><option value="2nd">2nd</option><option value="3rd">3rd</option>`})
  ]));

  // 7-16 Battery attempts & accuracy (5 batteries)
  // For each: attempts and avg accuracy
  const batteries = [
    {id:'1',title:'Memory (Figure-Find Memory)',attMax:24},
    {id:'2',title:'Directions (Watch)',attMax:20},
    {id:'3',title:'Depth Perception (Hidden Cube)',attMax:50},
    {id:'4',title:'Concentration (Figure Placement)',attMax:60},
    {id:'5',title:'Perceptual Speed (Same Figure Matching)',attMax:72}
  ];
  batteries.forEach((b,i)=>{
    const att = el('div',{},[
      el('label',{},[`${b.title} — Attempts (0 - ${b.attMax})`]),
      el('input',{id:'att'+(i+1),name:'att'+(i+1),type:'number',min:0,max:b.attMax,required:true})
    ]);
    const acc = el('div',{},[
      el('label',{},[`${b.title} — Avg accuracy (0 - 100)`]),
      el('input',{id:'acc'+(i+1),name:'acc'+(i+1),type:'number',min:0,max:100,required:true})
    ]);
    grid.appendChild(att);
    grid.appendChild(acc);
  });

  form.appendChild(grid);
  form.appendChild(el('div',{style:'margin-top:12px;display:flex;gap:10px'},[
    el('button',{class:'btn',type:'submit'},['Submit']),
    el('button',{type:'button',id:'resetBtn'},['Reset'])
  ]));

  container.appendChild(form);

  // handlers
  document.getElementById('resetBtn').addEventListener('click', ()=>{ document.getElementById('cform').reset(); });
  document.getElementById('cform').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    await handleFormSubmit();
  });
}

function selectYesNo(name, val) {
  const sel = el('select',{id:name,name:name, required:true});
  sel.innerHTML = '<option value="no">No</option><option value="yes">Yes</option>';
  if (val) sel.value = (val.toLowerCase()==='yes' ? 'yes' : 'no');
  return sel;
}

function zoneSelect(name, val) {
  const opts = ['Ahmedabad','Ajmer','Bangalore','Bhopal','Bhubaneswar','Bilaspur','Chandigarh','Chennai','Gorakhpur','Guwahati','Jammu and Srinagar','Kolkata','Malda','Mumbai','Muzzaffarpur','Muzaffarpur','Patna','Prayagraj','Ranchi','Secunderabad','Siliguri','Thiruvananthapuram'];
  // Note: user included both "Muzzafarpur" & "Muzaffarpur" - I added both to be safe (typo preserved).
  const sel = el('select',{id:name,name:name, required:true});
  sel.innerHTML = opts.map(o => `<option value="${o}">${o}</option>`).join('');
  if (val) sel.value = val;
  return sel;
}

/* ---------- Form submit logic ---------- */
async function handleFormSubmit() {
  // collect
  const form = document.getElementById('cform');
  const fd = new FormData(form);
  const data = {};
  for (const [k,v] of fd.entries()) data[k] = v;
  // convert numbers
  data.cbt2 = Number(data.cbt2);
  for (let i=1;i<=5;i++){
    data['att'+i] = Number(data['att'+i]);
    data['acc'+i] = Number(data['acc'+i]);
  }
  // validation
  if (!/^\d{15}$/.test(data.roll)) { alert('Roll must be exactly 15 digits'); return; }
  // check ranges (some already limited by input)
  if (data.cbt2 < 0 || data.cbt2 > 100) { alert('CBT2 must be 0-100'); return; }

  // check if roll exists
  showSpinner('Checking roll in database...');
  try {
    const chk = await fetch(GAS_WEBAPP_URL + '?action=checkroll&roll=' + encodeURIComponent(data.roll));
    const jo = await chk.json();
    hideSpinner();
    if (!jo.ok) { alert('Server error while checking roll'); return; }
    if (jo.exists) {
      // ask confirmation to overwrite
      if (!confirm('Roll exists. Are you sure you want to overwrite previous submission?')) {
        // fetch existing report instead
        await lookupRollAndShow(data.roll);
        return;
      }
    }
    // submit form via POST (urlencoded)
    showSpinner('Submitting data...');
    const body = new URLSearchParams();
    body.append('action','submit');
    for (const k in data) body.append(k, data[k]);
    const res = await fetch(GAS_WEBAPP_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: body.toString()
    });
    const json = await res.json();
    hideSpinner();
    if (!json.ok) { alert('Error from server: ' + (json.error || 'unknown')); return; }
    alert('Submitted successfully. Report generated below.');
    renderReport(json.report);
  } catch (err) {
    hideSpinner();
    alert('Error contacting server; see console.');
    console.error(err);
  }
}

/* ---------- Admin UI ---------- */
function showAdminPrompt() {
  const pw = prompt('Admin route: enter password to download CSV (admin only)');
  if (!pw) {
    document.getElementById('mainContent').innerHTML = '<div class="card warn">Admin access cancelled.</div>';
    return;
  }
  downloadAdminCsv(pw);
}

async function downloadAdminCsv(pw) {
  showSpinner('Generating CSV (admin)...');
  try {
    const url = GAS_WEBAPP_URL + '?action=admincsv&pw=' + encodeURIComponent(pw);
    const res = await fetch(url);
    // check content-type
    const ct = res.headers.get('content-type') || '';
    if (!ct.includes('text/csv')) {
      const j = await res.json();
      hideSpinner();
      alert('Admin error: ' + (j.error || 'unknown'));
      return;
    }
    const text = await res.text();
    hideSpinner();
    const blob = new Blob([text], { type: 'text/csv' });
    const urlB = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlB;
    a.download = 'alp_cbat_all.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(urlB);
    document.getElementById('mainContent').innerHTML = '<div class="card ok">CSV downloaded. (Check your browser downloads)</div>';
  } catch (err) {
    hideSpinner();
    alert('Error generating CSV. Check admin password and GAS web app settings.');
    console.error(err);
  }
}

/* ---------- Utilities ---------- */

function showSpinner(msg='Loading...') {
  let s = document.getElementById('spinOverlay');
  if (!s) {
    s = el('div',{id:'spinOverlay',class:'modal'});
    s.style.pointerEvents = 'none';
    const inner = el('div',{class:'inner'});
    inner.innerHTML = `<div style="display:flex;align-items:center;gap:12px"><div class="ok" style="padding:8px;border-radius:50%"><svg width="18" height="18" viewBox="0 0 24 24"><path fill="#0b63d6" d="M12 2v4"/></svg></div><div><strong>${msg}</strong><div class="tiny">Please wait</div></div></div>`;
    s.appendChild(inner);
    document.body.appendChild(s);
  } else {
    s.querySelector('.inner strong').textContent = msg;
  }
}

function hideSpinner() {
  const s = document.getElementById('spinOverlay');
  if (s) s.remove();
}

function round(x, d=2){
  return Math.round((x||0) * Math.pow(10,d)) / Math.pow(10,d);
}
</script>
</body>
</html>
