<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRB ALP 2024 CBAT Reports</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .telegram-link {
            background: #0088cc;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            text-decoration: none;
            transition: background 0.3s;
        }

        .telegram-link:hover {
            background: #006699;
        }

        .container {
            max-width: 1250px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .cbatForm {
            max-width: 1000px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            margin-bottom: 2rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: auto;
            margin-right: 0.5rem;
        }

        .reports-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }


        .report-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
        }

        .report-section h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .battery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .battery-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .battery-item h4 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .battery-item .score {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .overall-score {
            background: rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            margin-top: 1rem;
        }

        .overall-score h3 {
            margin-bottom: 0.5rem;
        }

        .overall-score .score {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .student-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }

        .student-info h2 {
            margin-bottom: 1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .error {
            color: #e74c3c;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .success {
            color: #27ae60;
            font-weight: 500;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <a class="navbar-brand" href="{{ url_for('home') }}"> 
                RRB ALP 2024 CBAT Reports
                </a>
            </div>
            <a href="https://t.me/Akki_Inspire" class="telegram-link" target="_blank">
                üì¢ Get CSV on Telegram
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- Initial Modal -->
        <div id="initialModal" class="modal" style="display: block;">
            <div class="modal-content">
                <h2>Welcome to CBAT Reports</h2>
                <p style="margin: 1rem 0;">Have you filled the CBAT form earlier on this website?</p>
                <button class="btn" onclick="showRollNoInput()">Yes</button>
                <button class="btn btn-secondary" onclick="showForm()">No</button>
            </div>
        </div>

        <!-- Roll Number Input Modal -->
        <div id="rollNoModal" class="modal">
            <div class="modal-content">
                <h2>Enter Your Roll Number</h2>
                <div class="form-group">
                    <label for="rollNoInput">ALP 2024 CBAT Roll No (15 digits):</label>
                    <input type="text" id="rollNoInput" maxlength="15" pattern="[0-9]{15}">
                    <div id="rollNoError" class="error hidden"></div>
                </div>
                <button class="btn" onclick="checkRollNo()">Get Reports</button>
                <button class="btn btn-secondary" onclick="backToInitial()">Back</button>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <h2>Roll Number Already Exists</h2>
                <p>Are you sure you want to change the data that was filled earlier on this site?</p>
                <button class="btn" onclick="confirmUpdate()">Yes, Update</button>
                <button class="btn btn-secondary" onclick="showExistingReports()">No, Show Existing Reports</button>
            </div>
        </div>

        <!-- CBAT Form -->
        <div id="cbatForm" class="card hidden">
            <h2> üìã CBAT Details Form</h2>
            <p style="margin-bottom: 1rem; color: #666;">
                <strong>Note:</strong> You will get the CSV file on my Telegram channel
                <br>
                <strong>‡§®‡•ã‡§ü:</strong> ‡§Ü‡§™‡§ï‡•ã CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§∞‡•á ‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§ö‡•à‡§®‡§≤ ‡§™‡§∞ ‡§Æ‡§ø‡§≤‡•á‡§ó‡•Ä

            </p>
            <form id="studentForm">
                <!-- Re-exam Question -->
                <div class="form-group">
                    <label>1. 
                        Have you been called for a re-exam of RRB ALP 2024 CBAT Exam on 31 August? 
                        <br>
                        ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§ï‡•ã 31 ‡§Ö‡§ó‡§∏‡•ç‡§§ ‡§ï‡•ã ‡§Ü‡§∞‡§Ü‡§∞‡§¨‡•Ä ‡§è‡§è‡§≤‡§™‡•Ä 2024 ‡§∏‡•Ä‡§¨‡•Ä‡§è‡§ü‡•Ä ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§™‡•Å‡§®‡§É ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡•Å‡§≤‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à?
                    </label>
                    <div class="radio-group">
                        <label><input type="radio" name="is_reexam" value="true" required> Yes</label>
                        <label><input type="radio" name="is_reexam" value="false" required> No</label>
                    </div>
                </div>

                <!-- Roll Number -->
                <div class="form-group">
                    <label for="form_roll_no">2. 
                        RRB ALP 2024 CBAT Exact Roll Number (15 digits exactly) [So you can later check updated Avg & T-score] 
                        <br>
                        ‡§Ü‡§∞‡§Ü‡§∞‡§¨‡•Ä ‡§è‡§è‡§≤‡§™‡•Ä 2024 ‡§∏‡•Ä‡§¨‡•Ä‡§è‡§ü‡•Ä ‡§∏‡§ü‡•Ä‡§ï ‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞ (‡§†‡•Ä‡§ï 15 ‡§Ö‡§Ç‡§ï) [‡§§‡§æ‡§ï‡§ø ‡§Ü‡§™ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è ‡§î‡§∏‡§§ ‡§î‡§∞ ‡§ü‡•Ä-‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç]:
                    </label>
                    <input type="text" id="form_roll_no" name="roll_no" maxlength="15" pattern="[0-9]{15}" required>
                </div>

                <!-- CBT2 Marks -->
                <div class="form-group">
                    <label for="cbt2_marks">3. 
                        ALP 2024 CBT 2 Exact Part A Marks [As in CBT 2 Score Card] 
                        <br>
                        ‡§è‡§è‡§≤‡§™‡•Ä 2024 ‡§∏‡•Ä‡§¨‡•Ä‡§ü‡•Ä 2 ‡§∏‡§ü‡•Ä‡§ï ‡§≠‡§æ‡§ó ‡§è ‡§Ö‡§Ç‡§ï [‡§∏‡•Ä‡§¨‡•Ä‡§ü‡•Ä 2 ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞](0-100):
                    </label>
                    <input type="number" id="cbt2_marks" name="cbt2_marks" min="0" max="100" step="0.01" required>
                </div>

                <!-- RRB Zone -->
                <div class="form-group">
                    <label for="rrb_zone">4. 
                        Applied RRB Zone [Zone Selected while filling RRB ALP 2024 Application Form] 
                        <br>
                        ‡§Ü‡§µ‡•á‡§¶‡§ø‡§§ ‡§Ü‡§∞‡§Ü‡§∞‡§¨‡•Ä ‡§ú‡•ã‡§® [‡§Ü‡§∞‡§Ü‡§∞‡§¨‡•Ä ‡§è‡§è‡§≤‡§™‡•Ä 2024 ‡§Ü‡§µ‡•á‡§¶‡§® ‡§™‡§§‡•ç‡§∞ ‡§≠‡§∞‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§ö‡§Ø‡§®‡§ø‡§§ ‡§ú‡•ã‡§®]:
                    </label>
                    <select id="rrb_zone" name="rrb_zone" required>
                        <option value="">Select RRB Zone</option>
                        <option value="Ahmedabad">Ahmedabad</option>
                        <option value="Ajmer">Ajmer</option>
                        <option value="Bangalore">Bangalore</option>
                        <option value="Bhopal">Bhopal</option>
                        <option value="Bhubaneswar">Bhubaneswar</option>
                        <option value="Bilaspur">Bilaspur</option>
                        <option value="Chandigarh">Chandigarh</option>
                        <option value="Chennai">Chennai</option>
                        <option value="Gorakhpur">Gorakhpur</option>
                        <option value="Guwahati">Guwahati</option>
                        <option value="Jammu and Srinagar">Jammu and Srinagar</option>
                        <option value="Kolkata">Kolkata</option>
                        <option value="Malda">Malda</option>
                        <option value="Mumbai">Mumbai</option>
                        <option value="Muzaffarpur">Muzaffarpur</option>
                        <option value="Patna">Patna</option>
                        <option value="Prayagraj">Prayagraj</option>
                        <option value="Ranchi">Ranchi</option>
                        <option value="Secunderabad">Secunderabad</option>
                        <option value="Siliguri">Siliguri</option>
                        <option value="Thiruvananthapuram">Thiruvananthapuram</option>
                    </select>
                </div>

                <!-- Exam Date -->
                <div class="form-group">
                    <label for="exam_date">5. RRB ALP 2024 CBAT Exam Date:</label>
                    <input type="date" id="exam_date" name="exam_date" value="2024-07-15" required readonly>
                </div>

                <!-- Shift -->
                <div class="form-group">
                    <label>6. Shift:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="shift" value="first" required> First</label>
                        <label><input type="radio" name="shift" value="second" required> Second</label>
                    </div>
                </div>

                <!-- Battery Test 1 - Memory -->
                <div class="form-group">
                    <label for="memory_attempts">7. Memory (Figure-Find Memory) Battery Test 1 Attempts (0-24):</label>
                    <input type="number" id="memory_attempts" name="memory_attempts" min="0" max="24" required>
                </div>

                <div class="form-group">
                    <label for="memory_accuracy">8. Your avg accuracy in test series for Memory Battery Test 1 (0-100%):</label>
                    <input type="number" id="memory_accuracy" name="memory_accuracy" min="0" max="100" step="0.01" required>
                </div>

                <!-- Battery Test 2 - Directions -->
                <div class="form-group">
                    <label for="directions_attempts">9. Directions (Watch) Battery Test 2 Attempts (0-20):</label>
                    <input type="number" id="directions_attempts" name="directions_attempts" min="0" max="20" required>
                </div>

                <div class="form-group">
                    <label for="directions_accuracy">10. Your avg accuracy in test series for Directions Battery Test 2 (0-100%):</label>
                    <input type="number" id="directions_accuracy" name="directions_accuracy" min="0" max="100" step="0.01" required>
                </div>

                <!-- Battery Test 3 - Depth Perception -->
                <div class="form-group">
                    <label for="depth_attempts">11. Depth Perception (Hidden Cube) Battery Test 3 Attempts (0-50):</label>
                    <input type="number" id="depth_attempts" name="depth_attempts" min="0" max="50" required>
                </div>

                <div class="form-group">
                    <label for="depth_accuracy">12. Your avg accuracy in test series for Depth Perception Battery Test 3 (0-100%):</label>
                    <input type="number" id="depth_accuracy" name="depth_accuracy" min="0" max="100" step="0.01" required>
                </div>

                <!-- Battery Test 4 - Concentration -->
                <div class="form-group">
                    <label for="concentration_attempts">13. Concentration (Figure Placement) Battery Test 4 Attempts (0-60):</label>
                    <input type="number" id="concentration_attempts" name="concentration_attempts" min="0" max="60" required>
                </div>

                <div class="form-group">
                    <label for="concentration_accuracy">14. Your avg accuracy in test series for Concentration Battery Test 4 (0-100%):</label>
                    <input type="number" id="concentration_accuracy" name="concentration_accuracy" min="0" max="100" step="0.01" required>
                </div>

                <!-- Battery Test 5 - Perceptual Speed -->
                <div class="form-group">
                    <label for="perceptual_attempts">15. Perceptual Speed (Same Figure Matching) Battery Test 5 Attempts (0-72):</label>
                    <input type="number" id="perceptual_attempts" name="perceptual_attempts" min="0" max="72" required>
                </div>

                <div class="form-group">
                    <label for="perceptual_accuracy">16. Your avg accuracy in test series for Perceptual Speed Battery Test 5 (0-100%):</label>
                    <input type="number" id="perceptual_accuracy" name="perceptual_accuracy" min="0" max="100" step="0.01" required>
                </div>

                <button type="submit" class="btn">Submit Form</button>
                <button type="button" class="btn btn-secondary" onclick="backToInitial()">Back</button>
            </form>

            <div id="formMessage"></div>
        </div>

        <!-- Reports Section -->
        <div id="reportsSection" class="hidden">
            <!-- Student Information -->
            <div id="studentInfo" class="student-info">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Reports Container -->
            <div id="reportsContainer">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let currentStudentData = null;
        let confirmingUpdate = false;

        // Show roll number input
        function showRollNoInput() {
            document.getElementById('initialModal').style.display = 'none';
            document.getElementById('rollNoModal').style.display = 'block';
        }

        // Show form
        function showForm() {
            document.getElementById('initialModal').style.display = 'none';
            document.getElementById('cbatForm').classList.remove('hidden');
        }

        // Back to initial modal
        function backToInitial() {
            document.getElementById('rollNoModal').style.display = 'none';
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('cbatForm').classList.add('hidden');
            document.getElementById('reportsSection').classList.add('hidden');
            document.getElementById('initialModal').style.display = 'block';
            
            // Clear any error messages
            document.getElementById('rollNoError').classList.add('hidden');
            document.getElementById('formMessage').innerHTML = '';
            
            // Reset form
            document.getElementById('studentForm').reset();
            document.getElementById('rollNoInput').value = '';
        }

        // Check roll number
        async function checkRollNo() {
            const rollNo = document.getElementById('rollNoInput').value.trim();
            const errorDiv = document.getElementById('rollNoError');
            
            // Validate roll number
            if (rollNo.length !== 15 || !/^\d{15}$/.test(rollNo)) {
                errorDiv.textContent = 'Please enter exactly 15 digits';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                const response = await fetch('/check_roll_no', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ roll_no: rollNo })
                });
                
                const data = await response.json();
                
                if (data.exists) {
                    currentStudentData = data.student_data;
                    await getReports(rollNo);
                } else {
                    errorDiv.textContent = 'Roll number not found. Please fill the form first.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Error checking roll number. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        }

        // Get reports for existing student
        async function getReports(rollNo) {
            try {
                const response = await fetch('/get_reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ roll_no: rollNo })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayReports(data);
                } else {
                    document.getElementById('rollNoError').textContent = data.error || 'Error getting reports';
                    document.getElementById('rollNoError').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('rollNoError').textContent = 'Error getting reports. Please try again.';
                document.getElementById('rollNoError').classList.remove('hidden');
            }
        }

        // Display reports
        function displayReports(data) {
            // Hide modals and form
            document.getElementById('rollNoModal').style.display = 'none';
            document.getElementById('cbatForm').classList.add('hidden');
            
            // Show reports section
            document.getElementById('reportsSection').classList.remove('hidden');
            
            // Display student info
            const studentInfo = document.getElementById('studentInfo');
            studentInfo.innerHTML = `
                <h2>Student Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <strong>Roll Number:</strong><br>${data.student_info.roll_no}
                    </div>
                    <div class="info-item">
                        <strong>Exam Date:</strong><br>${data.student_info.exam_date}
                    </div>
                    <div class="info-item">
                        <strong>Shift:</strong><br>${data.student_info.shift}
                    </div>
                    <div class="info-item">
                        <strong>RRB Zone:</strong><br>${data.student_info.rrb_zone}
                    </div>
                    <div class="info-item">
                        <strong>Part A Marks:</strong><br>${data.student_info.cbt2_marks}
                    </div>
                    <div class="info-item">
                        <strong>Re-Exam Status:</strong><br>${data.student_info.is_reexam ? 'Re-Exam Candidate' : 'Regular Candidate'}
                    </div>
                </div>
            `;
            
            // Display reports
            const reportsContainer = document.getElementById('reportsContainer');
            let reportsHtml = '';
            
            Object.keys(data.reports).forEach(reportKey => {
                const report = data.reports[reportKey];
                reportsHtml += `
                    <div class="report-section">
                        <h3> üìä ${report.comparison_group}</h3>
                        
                        <div class="battery-grid">
                            <div class="battery-item">
                                <h4> üß† Battery 1 (Memory)</h4>
                                <div class="score">${report.t_scores.memory.toFixed(2)}</div>
                                <div>Mean: ${report.battery_stats.memory.mean.toFixed(2)}</div>
                                <div>SD: ${report.battery_stats.memory.std.toFixed(2)}</div>
                            </div>
                            <div class="battery-item">
                                <h4> üëÅÔ∏è Battery 2 (Directions)</h4>
                                <div class="score">${report.t_scores.directions.toFixed(2)}</div>
                                <div>Mean: ${report.battery_stats.directions.mean.toFixed(2)}</div>
                                <div>SD: ${report.battery_stats.directions.std.toFixed(2)}</div>
                            </div>
                            <div class="battery-item">
                                <h4> üîç Battery 3 (Depth)</h4>
                                <div class="score">${report.t_scores.depth.toFixed(2)}</div>
                                <div>Mean: ${report.battery_stats.depth.mean.toFixed(2)}</div>
                                <div>SD: ${report.battery_stats.depth.std.toFixed(2)}</div>
                            </div>
                            <div class="battery-item">
                                <h4> üéØ Battery 4 (Concentration)</h4>
                                <div class="score">${report.t_scores.concentration.toFixed(2)}</div>
                                <div>Mean: ${report.battery_stats.concentration.mean.toFixed(2)}</div>
                                <div>SD: ${report.battery_stats.concentration.std.toFixed(2)}</div>
                            </div>
                            <div class="battery-item">
                                <h4> ‚ö° Battery 5 (Perceptual)</h4>
                                <div class="score">${report.t_scores.perceptual.toFixed(2)}</div>
                                <div>Mean: ${report.battery_stats.perceptual.mean.toFixed(2)}</div>
                                <div>SD: ${report.battery_stats.perceptual.std.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div class="overall-score">
                            <h3> üìà Overall Score (Out of 30)</h3>
                            <div class="score">${report.overall_score}</div>
                        </div>
                    </div>
                `;
            });
            
            reportsContainer.innerHTML = reportsHtml;
        }

        // Form submission
        document.getElementById('studentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                roll_no: formData.get('roll_no'),
                is_reexam: formData.get('is_reexam') === 'true',
                cbt2_marks: formData.get('cbt2_marks'),
                rrb_zone: formData.get('rrb_zone'),
                exam_date: formData.get('exam_date'),
                shift: formData.get('shift'),
                memory_attempts: formData.get('memory_attempts'),
                memory_accuracy: formData.get('memory_accuracy'),
                directions_attempts: formData.get('directions_attempts'),
                directions_accuracy: formData.get('directions_accuracy'),
                depth_attempts: formData.get('depth_attempts'),
                depth_accuracy: formData.get('depth_accuracy'),
                concentration_attempts: formData.get('concentration_attempts'),
                concentration_accuracy: formData.get('concentration_accuracy'),
                perceptual_attempts: formData.get('perceptual_attempts'),
                perceptual_accuracy: formData.get('perceptual_accuracy'),
                confirm_update: confirmingUpdate
            };
            
            try {
                const response = await fetch('/submit_form', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                const messageDiv = document.getElementById('formMessage');
                
                if (result.exists && !confirmingUpdate) {
                    // Show confirmation modal
                    document.getElementById('confirmModal').style.display = 'block';
                    confirmingUpdate = false;
                } else if (result.success) {
                    messageDiv.innerHTML = '<div class="success">Form submitted successfully! Generating reports...</div>';
                    // Get reports after successful submission
                    setTimeout(() => {
                        getReports(data.roll_no);
                    }, 1000);
                } else {
                    messageDiv.innerHTML = `<div class="error">${result.error || 'Error submitting form'}</div>`;
                }
            } catch (error) {
                document.getElementById('formMessage').innerHTML = '<div class="error">Error submitting form. Please try again.</div>';
            }
        });

        // Confirm update
        function confirmUpdate() {
            confirmingUpdate = true;
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('studentForm').dispatchEvent(new Event('submit'));
        }

        // Show existing reports
        function showExistingReports() {
            document.getElementById('confirmModal').style.display = 'none';
            const rollNo = document.getElementById('form_roll_no').value;
            getReports(rollNo);
        }
    </script>
</body>
</html>